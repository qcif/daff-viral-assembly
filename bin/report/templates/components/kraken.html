{% set term_filter_idx = kraken.columns_primary_display.index('term_filter') %}

<h2>Direct taxonomic read classification (Kraken/Braken)</h2>

<div class="alert alert-info">
  <div class="row align-items-center">
    <div class="col">
      <strong>Kraken</strong> attempts to classify each individual sequencing read to species level. The number of reads allocated to each species are shown in the table. This gives us a rough estimate of the taxonomic distribution of genetic material in the sample.

      The <strong>Terms to exclude</strong> column allows you to filter out sequences that match a 
      <a href="javascript:void(0);" data-bs-toggle="modal" data-bs-target="#filterKeywordsModal">
        pre-defined list of terms</a>.
    </div>
    <div class="col-auto">
      <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#krakenInfoModal">
        About this analysis
      </button>
    </div>
  </div>
</div>

<div class="row justify-content-start my-3">
  {% if kraken | length %}
  <div class="col-sm-6" style="overflow-x: auto;">
    <p class="text-end">
      <button
        class="btn btn-secondary btn-sm float-right"
        onclick="clearKrakenTableFilters();"
        role="button"
      >
        Clear filters
      </button>
    </p>

    <table id="krakenTable" class="table table-lined tight text-center">
      <thead>
        <tr>
          {% for colname in kraken.columns_primary_display  %}
          <th
            {% if kraken.COLUMN_METADATA[colname]['tooltip'] %}
            title="{{ kraken.COLUMN_METADATA[colname]['tooltip'] }}"
            data-bs-toggle="tooltip"
            data-bs-placement="top"
            {% endif %}
          >
            {{ kraken.COLUMN_METADATA[colname]['label'] }}
          </th>
          {% endfor %}
        </tr>
        <tr class="filters">
          {% for colname in kraken.columns_primary_display %}
            <th></th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in kraken %}
        <tr
          {% if row['bs_class'] %}
          class="alert-{{ row['bs_class'] }}"
          {% endif %}
        >
          {% for colname in kraken.columns_primary_display  %}
          <td class="align-middle {% if loop.index == 1 %}text-start{% endif %}">
            {% if colname == 'evalue' %}
            <span style="white-space: nowrap;">{{ row[colname] }}</span>
            {% elif colname == 'term_filter' %}
            {{ '' if row[colname] else 'Y' }}
            {% elif kraken.COLUMN_METADATA[colname]['type'] == 'float' %}
              {% if row[colname] is number %}
              {{ '%.3g' | format(row[colname]) }}
              {% else %}
              {{ row[colname] }}
              {% endif %}
            {% else %}
            {{ row[colname] }}
            {% endif %}
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="col-sm-6">
    {% include 'components/kraken-pie-charts.html' %}
  </div>
  {% else %}
  <p>
    No taxonomic classification results to show.
  </p>
  {% endif %}
</div>

<div class="modal fade" id="krakenInfoModal" tabindex="-1" aria-labelledby="krakenInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="krakenInfoModalLabel">Taxonomic classification with Kraken2</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <ol>
          <li>
            <strong>Kraken</strong> classifies sequencing reads against a reference nucleotide database (<code>k2_core_nt_20250609</code>) to assign taxonomic labels to each read.
          </li>
          <li>
            Pytaxonkit is subsequently used to retrieve the full taxonomic lineage for each taxid identified by Kraken, and the NCBI taxonomy is used to determine which of those are viruses/viroids.
          </li>
          <li>
            The table below shows the number and percent of quality filtered reads assigned to each taxon identified by Kraken.
          </li>
          <li>
            Sort the table by alphabetical or numerical order by clicking on column headers, and adjust the number of displayed entries using the dropdown menu above the table.
          </li>
          <li>
            The results can be limited to a specific taxon using the search box (for example "virus", or "sapiens").
          </li>
          <li>
            The table can be filtered to show only rows that satisfy the minimum coverage criteria and do not match any terms from a pre-defined exclusion list.
          </li>
          <li>
            The pie chart on the right provides a visual summary of the taxonomic composition at the kingdom level (top). The top 10 most abundant taxa detected within a kingdom can be displayed by clicking on the desired kingdom and these can be viewed at the family, genus or species level (bottom).
          </li>
        </ol>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>

  let krakenDataTable;

  $(document).ready( () => {
    krakenDataTable = new DataTable('#krakenTable', {
      pageLength: 25,
      order: [[1, 'desc']],
      orderCellsTop: true,
      columnDefs: [
        {
          targets: [ 5, 6, 7, 8, 9 ],
          visible: false,
          searchable: true,
        }
      ]
    });

  const boolIdx = 3;
   const column = krakenDataTable.column(boolIdx);
   const cell = $('#krakenTable thead tr.filters th').eq(boolIdx);

    $(
      '<select class="form-select form-select-sm">' +
        '<option value="">All</option>' +
        '<option value="TRUE">TRUE</option>' +
        '<option value="FALSE">FALSE</option>' +
      '</select>'
    )
    .appendTo(cell)
    .on('change', function () {
      const val = $.fn.dataTable.util.escapeRegex($(this).val());
      column
        .search(val ? '^' + val + '$' : '', true, false)
        .draw();
    });


  const termFilterIdx = {{ term_filter_idx }};

  (function () {
    const column = krakenDataTable.column(termFilterIdx);
    const cell = $('#krakenTable thead tr.filters th').eq(termFilterIdx);

    $('<select class="form-select form-select-sm" style="min-width: 4.5rem; white-space: nowrap;">' +
        '<option value="">All</option>' +
        '<option value="Y">Y</option>' +
        '<option value="blank">â€”</option>' +
      '</select>')
      .appendTo(cell)
      .on('change', function () {
        const val = $(this).val();
        if (val === "blank") {
          column.search('^$', true, false).draw();   // empty cell
        } else {
          column.search(val ? '^' + val + '$' : '', true, false).draw();
        }
      });
  })();
  });


  function clearKrakenTableFilters() {
    console.log('Clearing Kraken table filters');
    krakenDataTable.search('').columns().search('').draw();

    $('#krakenTable thead tr.filters select').val('');
  }
</script>
