<h2>Homology to viral reference sequences</h2>

<p>
  This section shows assembled contigs which match a known virus sequence in the reference BLAST database.
</p>

<p class="alert alert-warning">
  It is possible that not all sequences shown here match the sample organism.
  Erroneous sequences often result from sample contamination or from sequencing/assembly artefacts. It is the responsibility of the analyst to select the most appropriate sequence(s) for taxonomic identification based on the evidence shown. Furthermore, the results shown here <strong>cannot be used</strong> to make a confident assessment of the sample taxonomy. Taxonomic identity of a consensus sequence should be determined by an appropriate downstream analysis.
</p>

<ul class="lead">
  <li>
    {{ contigs_fasta | length }} contigs were assembled from cleaned reads.
  </li>
  <li>
    {{ blast_stats.count }}
    ({{ blast_stats.percent }}%)
    of contigs matched a reference sequence with BLAST.
  </li>
</ul>

<div class="my-3" style="overflow-x: auto;">

  {% if blast_hits | length %}
  <table class="table table-lined tight text-center">
    <thead>
      <tr>
        {% for colname in blast_hits.columns_primary_display %}
        <th
          {% if blast_hits.COLUMN_METADATA[colname]['tooltip'] %}
          title="{{ blast_hits.COLUMN_METADATA[colname]['tooltip'] }}"
          data-bs-toggle="tooltip"
          data-bs-placement="top"
          {% endif %}
        >
          {{ blast_hits.COLUMN_METADATA[colname]['label'] }}
        </th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in blast_hits %}
      <tr
        {% if row['bs_class'] %}
        class="alert-{{ row['bs_class'] }}"
        {% endif %}
      >
        {% for colname in blast_hits.columns_primary_display %}
        <td>
          {% if colname == 'evalue' %}
          <span style="white-space: nowrap;">{{ row[colname] }}</span>
          {% else %}
          {{ row[colname] }}
          {% endif %}
        </td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    {% if not blast_passed %}
    <p class="alert alert-danger">
      BLAST search against reference sequences failed . Therefore, only a limited report is available as no coverage statistics were generated. Blast homology search can fail when the consensuses generated are too short. If this is the case for this sample, consider relaxing the criteria at the quality filtering step and/or reducing the minimum read length during cluster generation.
    </p>
    {% else %}
    <p class="alert alert-info">
      No consensus sequences matched a reference with BLAST. This implies that the consensus sequence(s) are from novel species, or are the result of assembly artifact(s).
      <!-- TODO: verify this -->
    </p>
    {% endif %}
  {% endif %}
</div>

{% if blast_hits | length %}
<button
  type="button"
  class="btn btn-primary"
  data-bs-toggle="modal"
  data-bs-target="#consensusBlastModal"
>
  Consensus statistics
</button>

<a
  class="btn btn-primary hide-broken"
  href="{{ bam_html_file }}"
  target="_blank"
>
  Read alignment (BAM)
</a>

<button
  class="btn btn-primary"
  type="button"
  data-bs-toggle="modal"
  data-bs-target="#flagDefinitionsModal"
>
  Flag definitions
</button>
{% endif %}

{% include 'components/fasta-modal.html' %}
{% if blast_hits | length %}
  {% include 'components/blast-modal.html' %}
  {% include 'components/flag-definitions-modal.html' %}
{% endif %}
