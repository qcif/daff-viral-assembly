<h2>Direct taxonomic read classification (Kaiju)</h2>

<div class="alert alert-info">
  <div class="row align-items-center">
    <div class="col">
      <strong>Kaiju</strong> is very similar to <strong>Kraken</strong>, but sometimes identifies species that the latter does not. <strong>Kaiju</strong> operates on protein sequences, meaning that it cannot identify viroids sequences. It attempts to classify each individual sequencing read to species level. The number of reads allocated to each species are shown in the table. This gives us a rough estimate of the taxonomic distribution of genetic material in the sample. Please note that the database used by Kaiju does not include sequences from higher eukaryotes, meaning that reads originating from the host organism will not be classified in this analysis. 

      The <strong>Matches keywords</strong> column indicates whether the taxon name matches a specified
      <a href="javascript:void(0);" data-bs-toggle="modal" data-bs-target="#filterKeywordsModal">
        list of terms</a>.
    </div>
    <div class="col-auto">
      <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#kaijuInfoModal">
        About this analysis
      </button>
    </div>
  </div>
</div>

<div class="row justify-content-start my-3">

  {% if kaiju | length %}
  <div class="col-sm-6" style="overflow-x: auto;">
    <p class="text-end">
      <button
        class="btn btn-secondary btn-sm float-right"
        onclick="clearKaijuTableFilters();"
        role="button"
      >
        Clear filters
      </button>
    </p>

    <table id="kaijuTable" class="table table-lined tight text-center">
      <thead>
        <tr>
          {% for colname in kaiju.columns_primary_display %}
          <th
            {% if kaiju.COLUMN_METADATA[colname]['tooltip'] %}
            title="{{ kaiju.COLUMN_METADATA[colname]['tooltip'] }}"
            data-bs-toggle="tooltip"
            data-bs-placement="top"
            {% endif %}
          >
            {{ kaiju.COLUMN_METADATA[colname]['label'] }}
          </th>
          {% endfor %}
        </tr>
        <tr class="filters">
          {% for colname in kaiju.columns_primary_display %}
            <th></th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in kaiju %}
        <tr
          {% if row['bs_class'] %}
          class="alert-{{ row['bs_class'] }}"
          {% endif %}
        >
          {% for colname in kaiju.columns_primary_display  %}
          <td class="align-middle {% if loop.index == 1 %}text-start{% endif %}">
            {% if colname == 'evalue' %}
            <span style="white-space: nowrap;">{{ row[colname] }}</span>
            {% elif kaiju.COLUMN_METADATA[colname]['type'] == 'float' %}
              {% if row[colname] is number %}
              {{ '%.3g' | format(row[colname]) }}
              {% else %}
              {{ row[colname] }}
              {% endif %}
            {% else %}
            {{ row[colname] }}
            {% endif %}
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="col-sm-6">
    {% include 'components/kaiju-pie-charts.html' %}
  </div>
  {% else %}
  <p>
    No taxonomic classification results to show.
  </p>
  {% endif %}
</div>

<div class="modal fade" id="kaijuInfoModal" tabindex="-1" aria-labelledby="kaijuInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="kaijuInfoModalLabel">Taxonomic classification with Kaiju</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <ol>
          <li>
            <strong>Kaiju</strong> translates sequencing reads into amino acid sequences and compares them to a reference protein database (<code>kaiju_db_nr_euk_2023-05-10</code>) to assign taxonomic labels to each read.
          </li>
          <li>
            This database represents a curated subset of the NCBI nr database and includes protein sequences from Archaea, bacteria, viruses, fungi, and microbial eukaryotes. 
            It does not include sequences from higher eukaryotes, meaning that reads originating from the host organism will not be classified by Kaiju.
          </li>
          <li>
            Pytaxonkit is subsequently used to retrieve the full taxonomic lineage for each taxid identified by Kaiju, and the NCBI taxonomy is used to determine which taxa are viruses/viroids.
          </li>
          <li>
            The table below shows the number and percent of quality filtered reads assigned to each taxon identified by Kaiju.
          </li>
          <li>
            Sort the table by alphabetical or numerical order by clicking on column headers, and adjust the number of displayed entries using the dropdown menu above the table.
          </li>
          <li>
            The results can be limited to a specific taxon using the search box (for example "virus", or "sapiens").
          </li>
          <li>
            The table can also be filtered to only show rows which meet minimum coverage criteria and match a pre-defined list of terms.
          </li>
          <li>
            The pie chart on the right provides a visual summary of the taxonomic composition at the kingdom level (top). The top 10 most abundant taxa detected within a kingdom can be displayed by clicking on the desired kingdom and these can be viewed at the family, genus or species level (bottom).
          </li>
          <li>
            <strong>Important note:</strong> since Kaiju performs a translated search against a protein database, it will not be able to detect viroids.
          </li>
        </ol>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>

  let kaijuDataTable;

  $(document).ready( () => {
    kaijuDataTable = new DataTable('#kaijuTable', {
      pageLength: 25,
      order: [[1, 'desc']],
      orderCellsTop: true,
      columnDefs: [
        {
          targets: [ 5, 6, 7, 8, 9 ],
          visible: false,
          searchable: true,
        }
      ]
    });

    const booleanColumns = [3, 4];

    booleanColumns.forEach(function (colIdx) {
      const column = kaijuDataTable.column(colIdx);
      const cell = $('#kaijuTable thead tr.filters th').eq(colIdx);

      const select = $(
        '<select class="form-select form-select-sm">' +
          '<option value="">All</option>' +
          '<option value="TRUE">TRUE</option>' +
          '<option value="FALSE">FALSE</option>' +
        '</select>'
      )
      .appendTo(cell)
      .on('change', function () {
        const val = $.fn.dataTable.util.escapeRegex($(this).val());
        column
          .search(val ? '^' + val + '$' : '', true, false)
          .draw();
      });
    });

  });


  function clearKaijuTableFilters() {
    kaijuDataTable.search('').columns().search('').draw();

    $('#kaijuTable thead tr.filters select').val('');
  }
</script>
