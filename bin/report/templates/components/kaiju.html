<h2>Direct taxonomic read classification (Kaiju)</h2>

<p>
  Kaiju is a bioinformatics tool that translates sequencing reads into amino acid sequences and compares them to a reference protein database (kaiju_db_nr_euk_2023-05-10) to assign taxonomic labels.<br>
  This database represents a curated subset of the NCBI nr database and includes protein sequences from Archaea, bacteria, viruses, fungi, and microbial eukaryotes.<br>
  Pytaxonkit is subsequently used to retrieve the full taxonomic lineage for each taxid identified by Kaiju, and the NCBI taxonomy is used to determine which taxa are viruses/viroids.<br>
  The table below shows the number and per cent of quality filtered reads assigned to each taxon identified by Kaiju.<br>
  It can be sorted by alphabetical or numerical order by clicking on the column headers, and the number of entries shown can be adjusted using the dropdown menu above the table.<br>
  The results can be limited to a specific taxon by typing its name in the search box (for example "virus").<br>
  The table can also be filtered to only show rows which meet minimum coverage criteria and default term criteria.<br>
  Important note: since Kaiju performs a translated search against a protein database, it will not be able to detect viroids.<br>
</p>

<div class="my-3" style="overflow-x: auto;">

  {% if kaiju | length %}
  <table id="kaijuTable" class="table table-lined tight text-center">
    <thead>
      <tr>
        {% for colname in kaiju.columns_primary_display %}
        <th
          {% if kaiju.COLUMN_METADATA[colname]['tooltip'] %}
          title="{{ kaiju.COLUMN_METADATA[colname]['tooltip'] }}"
          data-bs-toggle="tooltip"
          data-bs-placement="top"
          {% endif %}
        >
          {{ kaiju.COLUMN_METADATA[colname]['label'] }}
        </th>
        {% endfor %}
      </tr>
      <tr class="filters">
        {% for colname in kaiju.columns_primary_display %}
          <th></th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in kaiju %}
      <tr
        {% if row['bs_class'] %}
        class="alert-{{ row['bs_class'] }}"
        {% endif %}
      >
        {% for colname in kaiju.columns_primary_display  %}
        <td class="align-middle">
          {% if colname == 'evalue' %}
          <span style="white-space: nowrap;">{{ row[colname] }}</span>
          {% else %}
          {{ row[colname] }}
          {% endif %}
        </td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>
    No taxonomic classification results to show.
  </p>
  {% endif %}
</div>

<script>
$(document).ready(function () {

  var table = $('#kaijuTable').DataTable({
    orderCellsTop: true,
    fixedHeader: true
  });

  var booleanColumns = [3, 4];

  booleanColumns.forEach(function (colIdx) {
    var column = table.column(colIdx);
    var cell = $('#kaijuTable thead tr.filters th').eq(colIdx);

    var select = $('<select class="form-select form-select-sm">' +
                   '<option value="">All</option>' +
                   '<option value="TRUE">TRUE</option>' +
                   '<option value="FALSE">FALSE</option>' +
                   '</select>')
      .appendTo(cell)
      .on('change', function () {
        var val = $.fn.dataTable.util.escapeRegex($(this).val());
        column
          .search(val ? '^' + val + '$' : '', true, false)
          .draw();
      });
  });

});
</script>